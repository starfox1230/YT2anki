<!DOCTYPE html>


<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anki Defense: Card Siege</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --bg: #050816;
      --bg-soft: #0b1020;
      --accent: #3fb9ff;
      --accent-soft: rgba(63, 185, 255, 0.16);
      --accent-strong: #00e676;
      --danger: #ff5252;
      --danger-soft: rgba(255, 82, 82, 0.16);
      --text-main: #f9fbff;
      --text-soft: #a9b4d0;
      --card-bg: #111726;
      --card-border: #20283a;
      --button-bg: #1b2338;
      --button-bg-strong: #3fb9ff;
      --button-text: #ffffff;
      --hud-height: 52px;
    }


* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  margin: 0;
  padding: 0;
  background: radial-gradient(circle at top, #101739 0, #050816 55%);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: stretch;
}

#app, #reviewScreen {
  width: 100%;
  max-width: 540px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  position: relative;
  background: linear-gradient(to bottom, #050816 0%, #050816 40%, #03040b 100%);
}

.hidden {
  display: none !important;
}

/* HUD */

#hud {
  height: var(--hud-height);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  background: rgba(5, 9, 20, 0.96);
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 5;
}

.hud-section {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8rem;
  color: var(--text-soft);
}

.hud-label {
  text-transform: uppercase;
  letter-spacing: 0.07em;
  font-size: 0.68rem;
  opacity: 0.8;
}

.hud-value {
  font-weight: 600;
  color: var(--text-main);
}

#timerValue {
  font-variant-numeric: tabular-nums;
}

.pill {
  border-radius: 999px;
  padding: 2px 8px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  background: rgba(17, 23, 38, 0.9);
}

#pauseButton {
  border-radius: 999px;
  border: 0;
  padding: 6px 10px;
  background: rgba(31, 45, 90, 0.9);
  color: var(--text-main);
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  gap: 4px;
  font-weight: 500;
}

#pauseButton span.icon {
  display: inline-block;
  font-size: 0.9rem;
}

/* Playfield */

#playfield {
  position: relative;
  height: 32vh;
  min-height: 170px;
  margin: 8px 12px 0;
  border-radius: 18px;
  border: 1px solid rgba(63, 185, 255, 0.25);
  background: radial-gradient(circle at top, #182449 0%, #050816 55%, #02030a 100%);
  overflow: hidden;
  box-shadow: 0 14px 35px rgba(0, 0, 0, 0.75);
}

#playfieldInner {
  position: absolute;
  inset: 0;
}

.starfield {
  position: absolute;
  inset: 0;
  background-image:
    radial-gradient(2px 2px at 10% 20%, rgba(255, 255, 255, 0.6) 0, transparent 50%),
    radial-gradient(2px 2px at 80% 10%, rgba(63, 185, 255, 0.7) 0, transparent 50%),
    radial-gradient(1.5px 1.5px at 50% 80%, rgba(255, 255, 255, 0.55) 0, transparent 50%);
  opacity: 0.6;
  animation: stars 24s linear infinite;
  pointer-events: none;
}

@keyframes stars {
  0% { transform: translateY(0); }
  100% { transform: translateY(12%); }
}

.enemy {
  position: absolute;
  width: 26px;
  height: 26px;
  border-radius: 6px;
  background: radial-gradient(circle at 30% 20%, #ffeb3b 0, #ff9800 40%, #e91e63 80%);
  box-shadow: 0 0 14px rgba(255, 193, 7, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.4);
}

.enemy::after {
  content: "";
  position: absolute;
  inset: 4px;
  border-radius: 4px;
  border: 2px solid rgba(255, 255, 255, 0.4);
  box-sizing: border-box;
}

#base {
  position: absolute;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 20px;
  border-radius: 14px;
  background: linear-gradient(145deg, #1f2937, #3b4258);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible;
}

#base::before {
  content: "";
  position: absolute;
  top: -14px;
  left: 50%;
  transform: translateX(-50%);
  width: 32px;
  height: 14px;
  border-radius: 8px 8px 2px 2px;
  background: linear-gradient(to right, #3fb9ff, #00e5ff);
  box-shadow: 0 0 14px rgba(63, 185, 255, 0.7);
}

.laser {
  position: absolute;
  bottom: 22px;
  left: 50%;
  width: 4px;
  height: 80px;
  margin-left: -2px;
  border-radius: 999px;
  background: linear-gradient(to top, rgba(0, 229, 255, 0), #00e5ff);
  animation: laserUp 0.35s linear forwards;
  box-shadow: 0 0 12px rgba(0, 229, 255, 0.8);
  pointer-events: none;
}

@keyframes laserUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-160px); opacity: 0; }
}

#baseHealthBar {
  position: absolute;
  top: 6px;
  left: 6px;
  right: 6px;
  height: 5px;
  border-radius: 999px;
  background: rgba(0, 0, 0, 0.4);
  overflow: hidden;
}

#baseHealthInner {
  height: 100%;
  width: 100%;
  border-radius: inherit;
  background: linear-gradient(to right, #00e676, #ffeb3b, #ff5252);
  transform-origin: left center;
  transform: scaleX(1);
  transition: transform 0.15s linear;
}

#baseHealthLabel {
  position: absolute;
  bottom: -18px;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: rgba(169, 180, 208, 0.9);
}

.flash-good {
  animation: flashGood 0.3s ease-out;
}

.flash-bad {
  animation: flashBad 0.35s ease-out;
}

@keyframes flashGood {
  0% { box-shadow: 0 0 0 rgba(0, 230, 118, 0); }
  40% { box-shadow: 0 0 40px rgba(0, 230, 118, 0.7); }
  100% { box-shadow: 0 14px 35px rgba(0, 0, 0, 0.75); }
}

@keyframes flashBad {
  0% { box-shadow: 0 0 0 rgba(255, 82, 82, 0); }
  40% { box-shadow: 0 0 40px rgba(255, 82, 82, 0.7); }
  100% { box-shadow: 0 14px 35px rgba(0, 0, 0, 0.75); }
}

/* Card Panel */

#cardPanel {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 8px 12px 10px;
  gap: 8px;
}

#cardContainer {
  flex: 1;
  background: var(--card-bg);
  border-radius: 18px;
  padding: 14px 14px 12px;
  border: 1px solid var(--card-border);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 180px;
}

#cardHeaderRow {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.75rem;
  color: var(--text-soft);
}

#cardIndexLabel {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-weight: 600;
  font-size: 0.72rem;
}

#cardSpeedLabel {
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  background: rgba(10, 15, 32, 0.9);
  color: var(--accent);
}

#questionLabel {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--accent);
  opacity: 0.85;
}

#questionText, #answerText {
  font-size: 0.9rem;
  line-height: 1.4;
  color: var(--text-main);
  white-space: pre-wrap;
  word-wrap: break-word;
}

#answerText {
  margin-top: 4px;
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(63, 185, 255, 0.08);
  border: 1px dashed rgba(63, 185, 255, 0.35);
}

#cardTimerBarWrapper {
  margin-top: 4px;
  height: 6px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.06);
  overflow: hidden;
}

#cardTimerBar {
  height: 100%;
  width: 100%;
  border-radius: inherit;
  background: linear-gradient(to right, #00e676, #ffeb3b, #ff5252);
  transform-origin: left center;
  transform: scaleX(1);
  transition: transform 0.1s linear;
}

#cardControls {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
}

.button-row {
  display: flex;
  gap: 10px;
}

button.primary, button.secondary, button.ghost, button.chip {
  border-radius: 999px;
  border: none;
  font-size: 0.95rem;
  padding: 12px;
  flex: 1;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  background: var(--button-bg);
  color: var(--button-text);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
}

button.primary {
  background: linear-gradient(to right, #3fb9ff, #00e5ff);
  color: #020617;
}

button.secondary {
  background: linear-gradient(to right, rgba(63, 185, 255, 0.14), rgba(0, 229, 255, 0.07));
  border: 1px solid rgba(63, 185, 255, 0.4);
}

button.danger {
  background: linear-gradient(to right, rgba(255, 82, 82, 0.12), rgba(244, 67, 54, 0.18));
  border: 1px solid rgba(255, 82, 82, 0.7);
}

button.small {
  padding: 8px 10px;
  font-size: 0.8rem;
  box-shadow: none;
}

button.ghost {
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.14);
  box-shadow: none;
  flex: 0;
}

button.chip {
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.6);
  box-shadow: none;
  font-size: 0.8rem;
  padding: 8px 10px;
}

button:active {
  transform: translateY(1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
}

button:disabled {
  opacity: 0.5;
  box-shadow: none;
}

#bottomBar {
  padding: 4px 12px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
  font-size: 0.8rem;
  color: var(--text-soft);
}

#progressText {
  font-variant-numeric: tabular-nums;
}

/* Overlays */

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.92);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px 16px;
  z-index: 20;
}

.overlay-card {
  width: 100%;
  max-width: 420px;
  background: radial-gradient(circle at top, #111827 0, #020617 55%);
  border-radius: 20px;
  padding: 18px 16px 14px;
  border: 1px solid rgba(148, 163, 184, 0.45);
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.overlay-title {
  font-size: 1.1rem;
  font-weight: 700;
}

.overlay-subtitle {
  font-size: 0.85rem;
  color: var(--text-soft);
}

.overlay-stat-row {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  font-size: 0.85rem;
  margin-top: 4px;
}

.overlay-stat-label {
  color: var(--text-soft);
}

.overlay-stat-value {
  font-weight: 600;
  color: var(--accent);
}

.overlay-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* Review Screen */

#reviewHeader {
  height: var(--hud-height);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  background: rgba(5, 9, 20, 0.96);
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  position: sticky;
  top: 0;
  z-index: 5;
}

#reviewTitleBlock {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

#reviewTitle {
  font-size: 0.95rem;
  font-weight: 650;
}

#reviewSubtitle {
  font-size: 0.76rem;
  color: var(--text-soft);
}

#reviewFilters {
  padding: 8px 12px 6px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  background: radial-gradient(circle at top, #020617 0, #020617 60%);
}

#reviewFilters button {
  flex: 0;
}

#reviewList {
  flex: 1;
  overflow-y: auto;
  padding: 4px 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.review-item {
  background: rgba(15, 23, 42, 0.95);
  border-radius: 14px;
  padding: 9px 10px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  font-size: 0.82rem;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.review-item.correct {
  border-color: rgba(16, 185, 129, 0.7);
  box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
}

.review-item.wrong {
  border-color: rgba(248, 113, 113, 0.85);
  box-shadow: 0 4px 16px rgba(248, 113, 113, 0.25);
  background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.22), #020617 55%);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.review-header span.side {
  font-size: 0.75rem;
  color: var(--text-soft);
  font-variant-numeric: tabular-nums;
}

.review-q {
  color: var(--text-main);
}

.review-a {
  color: var(--text-soft);
  margin-top: 2px;
}

.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  padding: 0 6px;
  font-size: 0.7rem;
  font-weight: 600;
  border: 1px solid rgba(255, 255, 255, 0.24);
  min-width: 18px;
}

.badge.good {
  border-color: rgba(34, 197, 94, 0.9);
  color: #22c55e;
}

.badge.bad {
  border-color: rgba(239, 68, 68, 0.95);
  color: #f87171;
}

.badge.slow {
  border-color: rgba(245, 158, 11, 0.95);
  color: #fbbf24;
}

.review-empty {
  text-align: center;
  padding: 20px 12px;
  font-size: 0.85rem;
  color: var(--text-soft);
}

/* Utility */

.text-accent {
  color: var(--accent);
}

.text-danger {
  color: var(--danger);
}

.text-soft {
  color: var(--text-soft);
}

@media (max-height: 640px) {
  #playfield {
    height: 28vh;
  }
  #cardContainer {
    min-height: 160px;
  }
  button.primary, button.secondary, button.danger {
    padding-block: 10px;
  }
}

  </style>
</head>
<body>
<div id="app">
  <div id="hud">
    <div class="hud-section">
      <div class="pill">
        <div class="hud-label">Cards</div>
        <div class="hud-value" id="hudCards">0 / 0</div>
      </div>
    </div>
    <div class="hud-section">
      <div>
        <div class="hud-label">Score</div>
        <div class="hud-value" id="scoreValue">0</div>
      </div>
    </div>
    <div class="hud-section">
      <div>
        <div class="hud-label">Time</div>
        <div class="hud-value" id="timerValue">00:00</div>
      </div>
      <button id="pauseButton">
        <span class="icon" id="pauseIcon">⏸</span>
        <span id="pauseLabel">Pause</span>
      </button>
    </div>
  </div>


  <div id="playfield">
    <div id="playfieldInner">
      <div class="starfield"></div>
      <div id="baseHealthBar"><div id="baseHealthInner"></div></div>
      <div id="base"><span id="baseHealthLabel">Base</span></div>
    </div>
  </div>


  <div id="cardPanel">
    <div id="cardContainer">
      <div id="cardHeaderRow">
        <div id="cardIndexLabel">Card 1</div>
        <div id="cardSpeedLabel">Beat the timer!</div>
      </div>
      <div>
        <div id="questionLabel">Question</div>
        <div id="questionText"></div>
      </div>
      <div id="answerText" class="hidden"></div>
      <div id="cardTimerBarWrapper">
        <div id="cardTimerBar"></div>
      </div>
      <div id="cardControls">
        <div class="button-row" id="revealRow">
          <button class="primary" id="revealButton">
            Tap to reveal answer
          </button>
        </div>
        <div class="button-row hidden" id="markRow">
          <button class="secondary" id="rightButton">
            ✔ I got it right
          </button>
          <button class="danger" id="wrongButton">
            ✖ I got it wrong
          </button>
        </div>
      </div>
    </div>
  </div>


  <div id="bottomBar">
    <div id="progressText">Card 0 / 0</div>
    <button id="reviewButton" class="ghost small" disabled>Review</button>
  </div>
</div>


<div id="pauseOverlay" class="overlay hidden">
  <div class="overlay-card">
    <div class="overlay-title">Paused</div>
    <div class="overlay-subtitle">Timer and enemy advances are on hold. Ready when you are.</div>
    <div class="overlay-stat-row">
      <div>
        <div class="overlay-stat-label">Progress</div>
        <div class="overlay-stat-value" id="pauseProgressLabel">0 / 0</div>
      </div>
      <div>
        <div class="overlay-stat-label">Score</div>
        <div class="overlay-stat-value" id="pauseScoreLabel">0</div>
      </div>
      <div>
        <div class="overlay-stat-label">Time</div>
        <div class="overlay-stat-value" id="pauseTimeLabel">00:00</div>
      </div>
    </div>
    <div class="overlay-actions">
      <button class="primary" id="resumeButton">Resume</button>
      <button class="secondary" id="pauseToReviewButton">Review so far</button>
    </div>
  </div>
</div>


<div id="endOverlay" class="overlay hidden">
  <div class="overlay-card">
    <div class="overlay-title" id="endTitle">Wave cleared!</div>
    <div class="overlay-subtitle" id="endSubtitle">Nice work. Here is how that run went.</div>
    <div class="overlay-stat-row">
      <div>
        <div class="overlay-stat-label">Correct</div>
        <div class="overlay-stat-value" id="endCorrectLabel">0</div>
      </div>
      <div>
        <div class="overlay-stat-label">Accuracy</div>
        <div class="overlay-stat-value" id="endAccuracyLabel">0%</div>
      </div>
      <div>
        <div class="overlay-stat-label">Base Health</div>
        <div class="overlay-stat-value" id="endHealthLabel">100%</div>
      </div>
    </div>
    <div class="overlay-stat-row">
      <div>
        <div class="overlay-stat-label">Score</div>
        <div class="overlay-stat-value" id="endScoreLabel">0</div>
      </div>
      <div>
        <div class="overlay-stat-label">Elapsed</div>
        <div class="overlay-stat-value" id="endTimeLabel">00:00</div>
      </div>
    </div>
    <div class="overlay-actions">
      <button class="primary" id="endReviewButton">Review answers</button>
      <button class="secondary" id="endReplayButton">Play again</button>
    </div>
  </div>
</div>


<div id="reviewScreen" class="hidden">
  <div id="reviewHeader">
    <div id="reviewTitleBlock">
      <div id="reviewTitle">Run breakdown</div>
      <div id="reviewSubtitle">Tap a filter to focus weak spots.</div>
    </div>
    <button id="backToGameButton" class="ghost small">Back</button>
  </div>
  <div id="reviewFilters">
    <button id="filterAll" class="chip">All cards</button>
    <button id="filterWrong" class="chip">Wrong only</button>
    <button id="filterSlow" class="chip">Slowest first</button>
  </div>
  <div id="reviewList"></div>
</div>


<script>
  const cards = [
    {
      q: `Most common manifestation of cardiac metastases is [...]pericardial effusion; the second most is [...]pericardial lymph node involvement.`,
      a: `Most common manifestation of cardiac metastases is pericardial effusion; the second most is pericardial lymph node involvement.`
    },
    {
      q: `Most common primary cardiac tumor in adults (overall) is [...]left atrial myxoma`,
      a: `Most common primary cardiac tumor in adults (overall) is left atrial myxoma`
    },
    {
      q: `Overall Limb pattern in thanatophoric dysplasia: [...]micromelia per AIRP lecture, rhizomelia per crack the core.`,
      a: `Overall Limb pattern in thanatophoric dysplasia: micromelia per AIRP lecture, rhizomelia per crack the core. Notion AIRP Lecture Link`
    },
    {
      q: `Name the arthroplasty.[...]patellofemoral unicompartmental left knee arthroplasty`,
      a: `Name the arthroplasty.patellofemoral unicompartmental left knee arthroplasty`
    },
    {
      q: `What is the best description of the right breast findings?[...]Segmental non-mass enhancement`,
      a: `What is the best description of the right breast findings?Segmental non-mass enhancement`
    },
    {
      q: `Chapter HeadingsJesus expounds all things from the beginning to the end—Babes and children utter marvelous things that cannot be written—Those in the Church of Christ have all things in common among them. About A.D. 34.[...]3 Nephi 26`,
      a: `Chapter HeadingsJesus expounds all things from the beginning to the end—Babes and children utter marvelous things that cannot be written—Those in the Church of Christ have all things in common among them. About A.D. 34.3 Nephi 26 Read ChapterThe Gadianton War3 Nephi 1 - Nephi2 transmits the records to Nephi3. The signs of Jesus's birth are fulfilled. The Gadianton robbers dwell in the mountains and increase in number.3 Nephi 2 - The Nephites and Lamanites combine against the Gadianton Robbers.3 Nephi 3 - Giddianhi, the leader of the robbers, sends a letter to Lachoneus1. Lachoneus1 prepares his people for war. The Nephites gather together.3 Nephi 4 - The war with robbers resumes. The nephites win a war of attrition and give thanks to God.3 Nephi 5 - The end of the robbers. Mormon2's editorial comments.Society Devolves into Tribes3 Nephi 6 - The Nephites rebuild and prosper. Inequality breaks up the church. Prophets are assassinated; a secret combination forms to protect the murderers. 3 Nephi 7 - The central government collapses. Jacob4 becomes king of the secret combinations and the tribes establish a tenuous peace. Nephi3 preaches and performs miracles.The Destruction and the Voice3 Nephi 8 - The signs of Jesus's death.3 Nephi 9 - A voice proclaims the extent of the destruction. The voice of Jesus Christ proclaims his mission.3 Nephi 10 - Jesus's voice laments unaccepted mercies. The reaction of the people. Mormon2 comments on the fulfillment of prophecy.Jesus's Ministry Among the Nephites (3 Nephi 11-28)3 Nephi 11 - Jesus appears to the Nephites. They touch His side, hands, and feet. He calls the twelve disciples (we don't find out the number until chapter 12, which is where the chapter heading indicates they are called). The doctrine of Christ.Jesus's First Sermon to the Nephites (on the Law) (3 Nephi 12-18)The Nephite Version of the Sermon on the Mount (3 Nephi 12-14) / (Matthew 5-7)3 Nephi 12 - Jesus speaks the beatitudes. The witness of believers (salt of the earth, light on a candlestick). The fulfillment of the law. Matthew 5.3 Nephi 13 - Do good in secret; don't be a hypocrite. Lay up treasures in heaven. Jesus instructs the Twelve to rely on God for sustenance. Matthew 6.3 Nephi 14 - Parables of discipleship: judge not (beam and mote), ask of God (fish and serpent), beware of false prophets (sheep's clothing, ravening wolves). Matthew 7.Other Sheep3 Nephi 15 - More on the fulfillment of the Law. Jesus explains John 10:16 (other sheep I have...) to the Twelve.3 Nephi 16 - Other "other sheep." Jesus quotes the Father on the Gentiles and scattered IsraelJesus's Actions (Healing, Sacrament)3 Nephi 17 - Jesus heals the sick, prays, and blesses the children.3 Nephi 18 - Jesus institutes the sacrament. Instructions on prayer and fellowship. Jesus ascends to Heaven.Jesus's Second Sermon to the Nephites (on the Prophets) (3 Nephi 19-26)3 Nephi 19 - A greater multitude gathers. Nephi3 baptizes the Twelve. Jesus returns and prays concerning the Holy Ghost.3 Nephi 20 - Jesus administers the sacrament again. He quotes from Micah 5, Acts 3, and Isaiah 523 Nephi 21 -The Book of Mormon will be a sign for the gathering of Israel (an interpretation of Isaiah 52:13-15). Jesus quotes more from Micah 5.3 Nephi 22 - Jesus quotes from Isaiah 54. Zion and her stakes will be established, and Israel will be gathered in mercy and tenderness.3 Nephi 23 - Jesus declares: "Great are the words of Isaiah." Jesus corrects the Nephite records of Samuel's prophecies. 3 Nephi 24 - Jesus quotes Malachi 3: Messenger of the covenant, tithes and offerings, God will spare his own.3 Nephi 25 - Jesus quotes Malachi 4: judgement and covenant renewal.3 Nephi 26 - Jesus expounds all things and children utter marvelous things. Mormon2 is forbidden to give a full account.Jesus's Final Appearance 3 Nephi 27 - Jesus appears to the Twelve and names his church. "How be it my church save it be called in my name?" The gospel of Jesus Christ is outlined.3 Nephi 28 - Jesus grants the individual requests of the Twelve and departs. Mormon2 writes of the Three Disciples.Mormon's Conclusion to 3 Nephi3 Nephi 29 - The Book of Mormon as signal of covenant fulfillment.3 Nephi 30 - Mormon2 speaks the words of Christ to the Gentiles.`
    },
    {
      q: `Diagnosis?[...]spinal cord abscess`,
      a: `Diagnosis?spinal cord abscess Notion AIRP Lecture`
    },
    {
      q: `Diagnosis? ↻`,
      a: `LipomaImages`
    },
    {
      q: `What is the wrist subluxation pattern?[...]barton1/21/2`,
      a: `What is the wrist subluxation pattern?barton1/2 Notion AIRP Lecture`
    },
    {
      q: `Descriptors of Breast Density`,
      a: `Descriptors of Breast DensitySHOW ALLRemarksSourcesExtra 1Extra 2`
    },
    {
      q: `Most likely diagnosis?[...]well-differentiated liposarcoma`,
      a: `Most likely diagnosis?well-differentiated liposarcoma AIRP Retroperitoneum Lecture`
    },
    {
      q: `Jeune syndrome belongs to the [...]short rib thoracic dysplasia spectrum.`,
      a: `Jeune syndrome belongs to the short rib thoracic dysplasia spectrum. Notion AIRP Lecture Link`
    },
    {
      q: `In pancreatic neuroendocrine tumors, the rule of thumb that links tumor size with aggressiveness is summarized as [...]bigger is worse.`,
      a: `In pancreatic neuroendocrine tumors, the rule of thumb that links tumor size with aggressiveness is summarized as bigger is worse.`
    },
    {
      q: `Chapter HeadingsGiddianhi, the Gadianton leader, demands that Lachoneus and the Nephites surrender themselves and their lands—Lachoneus appoints Gidgiddoni as chief captain of the armies—The Nephites assemble in Zarahemla and Bountiful to defend themselves. About A.D. 16–18.[...]3 Nephi 3`,
      a: `Chapter HeadingsGiddianhi, the Gadianton leader, demands that Lachoneus and the Nephites surrender themselves and their lands—Lachoneus appoints Gidgiddoni as chief captain of the armies—The Nephites assemble in Zarahemla and Bountiful to defend themselves. About A.D. 16–18.3 Nephi 3 Read ChapterThe Gadianton War3 Nephi 1 - Nephi2 transmits the records to Nephi3. The signs of Jesus's birth are fulfilled. The Gadianton robbers dwell in the mountains and increase in number.3 Nephi 2 - The Nephites and Lamanites combine against the Gadianton Robbers.3 Nephi 3 - Giddianhi, the leader of the robbers, sends a letter to Lachoneus1. Lachoneus1 prepares his people for war. The Nephites gather together.3 Nephi 4 - The war with robbers resumes. The nephites win a war of attrition and give thanks to God.3 Nephi 5 - The end of the robbers. Mormon2's editorial comments.Society Devolves into Tribes3 Nephi 6 - The Nephites rebuild and prosper. Inequality breaks up the church. Prophets are assassinated; a secret combination forms to protect the murderers. 3 Nephi 7 - The central government collapses. Jacob4 becomes king of the secret combinations and the tribes establish a tenuous peace. Nephi3 preaches and performs miracles.The Destruction and the Voice3 Nephi 8 - The signs of Jesus's death.3 Nephi 9 - A voice proclaims the extent of the destruction. The voice of Jesus Christ proclaims his mission.3 Nephi 10 - Jesus's voice laments unaccepted mercies. The reaction of the people. Mormon2 comments on the fulfillment of prophecy.Jesus's Ministry Among the Nephites (3 Nephi 11-28)3 Nephi 11 - Jesus appears to the Nephites. They touch His side, hands, and feet. He calls the twelve disciples (we don't find out the number until chapter 12, which is where the chapter heading indicates they are called). The doctrine of Christ.Jesus's First Sermon to the Nephites (on the Law) (3 Nephi 12-18)The Nephite Version of the Sermon on the Mount (3 Nephi 12-14) / (Matthew 5-7)3 Nephi 12 - Jesus speaks the beatitudes. The witness of believers (salt of the earth, light on a candlestick). The fulfillment of the law. Matthew 5.3 Nephi 13 - Do good in secret; don't be a hypocrite. Lay up treasures in heaven. Jesus instructs the Twelve to rely on God for sustenance. Matthew 6.3 Nephi 14 - Parables of discipleship: judge not (beam and mote), ask of God (fish and serpent), beware of false prophets (sheep's clothing, ravening wolves). Matthew 7.Other Sheep3 Nephi 15 - More on the fulfillment of the Law. Jesus explains John 10:16 (other sheep I have...) to the Twelve.3 Nephi 16 - Other "other sheep." Jesus quotes the Father on the Gentiles and scattered IsraelJesus's Actions (Healing, Sacrament)3 Nephi 17 - Jesus heals the sick, prays, and blesses the children.3 Nephi 18 - Jesus institutes the sacrament. Instructions on prayer and fellowship. Jesus ascends to Heaven.Jesus's Second Sermon to the Nephites (on the Prophets) (3 Nephi 19-26)3 Nephi 19 - A greater multitude gathers. Nephi3 baptizes the Twelve. Jesus returns and prays concerning the Holy Ghost.3 Nephi 20 - Jesus administers the sacrament again. He quotes from Micah 5, Acts 3, and Isaiah 523 Nephi 21 -The Book of Mormon will be a sign for the gathering of Israel (an interpretation of Isaiah 52:13-15). Jesus quotes more from Micah 5.3 Nephi 22 - Jesus quotes from Isaiah 54. Zion and her stakes will be established, and Israel will be gathered in mercy and tenderness.3 Nephi 23 - Jesus declares: "Great are the words of Isaiah." Jesus corrects the Nephite records of Samuel's prophecies. 3 Nephi 24 - Jesus quotes Malachi 3: Messenger of the covenant, tithes and offerings, God will spare his own.3 Nephi 25 - Jesus quotes Malachi 4: judgement and covenant renewal.3 Nephi 26 - Jesus expounds all things and children utter marvelous things. Mormon2 is forbidden to give a full account.Jesus's Final Appearance 3 Nephi 27 - Jesus appears to the Twelve and names his church. "How be it my church save it be called in my name?" The gospel of Jesus Christ is outlined.3 Nephi 28 - Jesus grants the individual requests of the Twelve and departs. Mormon2 writes of the Three Disciples.Mormon's Conclusion to 3 Nephi3 Nephi 29 - The Book of Mormon as signal of covenant fulfillment.3 Nephi 30 - Mormon2 speaks the words of Christ to the Gentiles.`
    },
    {
      q: `Among the classic causes of neonatal low bowel obstruction, [...]Hirschsprung disease (so rectal biopsy is still required) may present with a normal contrast enema study.`,
      a: `Among the classic causes of neonatal low bowel obstruction, Hirschsprung disease (so rectal biopsy is still required) may present with a normal contrast enema study.`
    },
    {
      q: `The two view, full field digital mammography estimated lifetime attributable risk of cancer per 100,000 persons imaged is [...]1-5.`,
      a: `The two view, full field digital mammography estimated lifetime attributable risk of cancer per 100,000 persons imaged is 1-5. Most appropriate additional view?Repeat LMLO`
    },
    {
      q: `Important causes of a hyper-enhancing pancreatic lesion on arterial phase imaging include [...]pancreatic neuroendocrine tumor, metastatic renal cell carcinoma, duodenal gastrointestinal stromal tumor, solid appearing serous cystadenoma, and intrapancreatic accessory spleen.`,
      a: `Important causes of a hyper-enhancing pancreatic lesion on arterial phase imaging include pancreatic neuroendocrine tumor, metastatic renal cell carcinoma, duodenal gastrointestinal stromal tumor, solid appearing serous cystadenoma, and intrapancreatic accessory spleen.`
    },
    {
      q: `Key findings and most likely diagnosis?[...]Achondroplasia (tombstone iliac wings [square], interpedicular distance gradually diminishes in the lumbar spine)1/2`,
      a: `Key findings and most likely diagnosis?Achondroplasia (tombstone iliac wings [square], interpedicular distance gradually diminishes in the lumbar spine)1/2 Notion AIRP Lecture Link`
    },
    {
      q: `The anterior portion of the midbrain, ventral to the aqueduct, containing the red nucleus and substantia nigra, is the [...]tegmentum.`,
      a: `The anterior portion of the midbrain, ventral to the aqueduct, containing the red nucleus and substantia nigra, is the tegmentum.`
    },
    {
      q: `What carotid ultrasound finding is associated with Takayasu arteritis?[...]Echogenic smooth narrowing`,
      a: `What carotid ultrasound finding is associated with Takayasu arteritis?Echogenic smooth narrowing`
    },
    {
      q: `D&C OverviewMoroni quotes MalachiSection [...]2`,
      a: `D&C OverviewMoroni quotes MalachiSection 2`
    },
    {
      q: `Dental hardware and even mascara can cause [...]susceptibility artifact that degrades fat saturation.`,
      a: `Dental hardware and even mascara can cause susceptibility artifact that degrades fat saturation.`
    },
    {
      q: `Which is the phase encoding direction? What is the frequency-encoding direction?[...]phase encoding direction: anterior to posterior[...]frequency encoding direction: right to left`,
      a: `Which is the phase encoding direction? What is the frequency-encoding direction?phase encoding direction: anterior to posteriorfrequency encoding direction: right to left`
    },
    {
      q: `In a full term infant, the lung disease that places the child at highest risk for air leak syndromes such as pneumothorax and pneumomediastinum is [...]meconium aspiration.`,
      a: `In a full term infant, the lung disease that places the child at highest risk for air leak syndromes such as pneumothorax and pneumomediastinum is meconium aspiration.`
    },
    {
      q: `Contraindications to nitroglycerin for coronary CTA?[...]Systolic blood pressure less than 100; severe aortic stenosis; hypertrophic obstructive cardiomyopathy; recent phosphodiesterase inhibitor use`,
      a: `Contraindications to nitroglycerin for coronary CTA?Systolic blood pressure less than 100; severe aortic stenosis; hypertrophic obstructive cardiomyopathy; recent phosphodiesterase inhibitor use`
    },
    {
      q: `Which calcification morphology has the highest positive predictive value for ductal carcinoma in-situ?[...]Fine linear/fine linear branching`,
      a: `Which calcification morphology has the highest positive predictive value for ductal carcinoma in-situ?Fine linear/fine linear branching`
    },
    {
      q: `Nasopharyngeal carcinoma has an increased incidence in southeast Asia and is felt to be associated with what risk factor?[...]Epstein-Barr virus`,
      a: `Nasopharyngeal carcinoma has an increased incidence in southeast Asia and is felt to be associated with what risk factor?Epstein-Barr virus`
    },
    {
      q: `What type of breast calcification is this?[...]coarse heterogeneous`,
      a: `What type of breast calcification is this?coarse heterogeneous`
    },
    {
      q: `Diagnosis? ↻`,
      a: `pleomorphic liposarcomaImages`
    },
    {
      q: `The fusion direction of the metopic suture is [...]front to back.`,
      a: `The fusion direction of the metopic suture is front to back.`
    },
    {
      q: `What is the most likely diagnosis for a Lobulated mass in the left petrous apex has high T1 & T2 signal?[...]Cholesterol granuloma`,
      a: `What is the most likely diagnosis for a Lobulated mass in the left petrous apex has high T1 & T2 signal?Cholesterol granuloma`
    },
    {
      q: `Intralobar sequestration can get infected due to aeration via [...]pores of Kohn and canals of Lambert.`,
      a: `Intralobar sequestration can get infected due to aeration via pores of Kohn and canals of Lambert.`
    },
    {
      q: `Most likely diagnosis?[...]nerve sheath tumor (schwannoma vs neurofibroma)`,
      a: `Most likely diagnosis?nerve sheath tumor (schwannoma vs neurofibroma) AIRP Retroperitoneum Lecture`
    },
    {
      q: `Compared with pancreatic ductal adenocarcinoma enhancement, pancreatic neuroendocrine tumors usually appear [...]hyper-enhancing or at least iso-dense on arterial phase, whereas adenocarcinomas are typically hypo-enhancing.`,
      a: `Compared with pancreatic ductal adenocarcinoma enhancement, pancreatic neuroendocrine tumors usually appear hyper-enhancing or at least iso-dense on arterial phase, whereas adenocarcinomas are typically hypo-enhancing.`
    },
    {
      q: `The management for BI-RADS category [...]3 is short interval follow-up (6 months) or continued monitoring.`,
      a: `The management for BI-RADS category 3 is short interval follow-up (6 months) or continued monitoring.`
    },
    {
      q: `Clinical uses of Dotatate PET CT in neuroendocrine tumors include [...]whole-body staging, detection of occult bone metastases, and assessing somatostatin receptor status for prognosis and peptide receptor radionuclide therapy eligibility.`,
      a: `Clinical uses of Dotatate PET CT in neuroendocrine tumors include whole-body staging, detection of occult bone metastases, and assessing somatostatin receptor status for prognosis and peptide receptor radionuclide therapy eligibility.`
    },
    {
      q: `Ultrasound evaluation of the normal right lung in this patient shows the [...]pleural line (blue arrow) with multiple ripple-like echogenic lines extending deep (yellow lines), which are referred to as [...]A-lines.`,
      a: `Ultrasound evaluation of the normal right lung in this patient shows the pleural line (blue arrow) with multiple ripple-like echogenic lines extending deep (yellow lines), which are referred to as A-lines.`
    },
    {
      q: `What lymph node station is this?[...]sub-aortic (5)`,
      a: `What lymph node station is this?sub-aortic (5) Radiopaedia Annotated Lymph Node Stations`
    },
    {
      q: `What are some relative contraindications for TIPS placement often cited for board exams? [...]High MELD score (>20), severe/uncontrolled hepatic encephalopathy, right heart failure, portal vein thrombosis (relative)`,
      a: `What are some relative contraindications for TIPS placement often cited for board exams? High MELD score (>20), severe/uncontrolled hepatic encephalopathy, right heart failure, portal vein thrombosis (relative) Explanation: High MELD score suggests poor short-term survival. Uncontrolled encephalopathy can be worsened by TIPS. Right heart failure is an absolute contraindication. PVT makes the procedure more complex but is often overcome (relative contraindication).`
    },
    {
      q: `Diagnosis in young runner with hip pain:[...] stress fracture (specifically fatigue fracture) (no fracture line seen, but typical location)1/21/2`,
      a: `Diagnosis in young runner with hip pain: stress fracture (specifically fatigue fracture) (no fracture line seen, but typical location)1/2`
    },
    {
      q: `When lipomatosis affects a nerve territory with associated bone hypertrophy it is called [...]macrodystrophia lipomatosa.`,
      a: `When lipomatosis affects a nerve territory with associated bone hypertrophy it is called macrodystrophia lipomatosa.`
    },
    {
      q: `On a lateral chest radiograph, the left main pulmonary artery courses  [where with respect to key anatomic landmark]posterior to the left upper lobe bronchus`,
      a: `On a lateral chest radiograph, the left main pulmonary artery courses  posterior to the left upper lobe bronchus`
    },
    {
      q: `How is a slipped capital femoral epiphysis (SCFE) typically stabilized to preserve blood supply?[...]percutaneous in situ cannulated screw fixation, avoiding excessive manipulation (pin in place)`,
      a: `How is a slipped capital femoral epiphysis (SCFE) typically stabilized to preserve blood supply?percutaneous in situ cannulated screw fixation, avoiding excessive manipulation (pin in place)`
    }
  ];

  // Game state
  let currentIndex = 0;
  let score = 0;
  let correctCount = 0;
  let attempts = [];
  let paused = false;
  let sessionStart = null;
  let timerIntervalId = null;
  let revealShown = false;
  let cardCompleted = false;
  let currentRevealTime = null;
  const cardTimerTotalMs = 12000;
  let cardTimeRemainingMs = cardTimerTotalMs;
  let cardTimerExpired = false;
  let baseHealth = 100;
  let enemies = [];
  let baseDestroyed = false;

  // DOM
  const hudCardsEl = document.getElementById('hudCards');
  const scoreValueEl = document.getElementById('scoreValue');
  const timerValueEl = document.getElementById('timerValue');
  const pauseButtonEl = document.getElementById('pauseButton');
  const pauseIconEl = document.getElementById('pauseIcon');
  const pauseLabelEl = document.getElementById('pauseLabel');

  const playfieldEl = document.getElementById('playfield');
  const baseHealthInnerEl = document.getElementById('baseHealthInner');

  const cardIndexLabelEl = document.getElementById('cardIndexLabel');
  const cardSpeedLabelEl = document.getElementById('cardSpeedLabel');
  const questionTextEl = document.getElementById('questionText');
  const answerTextEl = document.getElementById('answerText');
  const cardTimerBarEl = document.getElementById('cardTimerBar');
  const revealRowEl = document.getElementById('revealRow');
  const markRowEl = document.getElementById('markRow');
  const revealButtonEl = document.getElementById('revealButton');
  const rightButtonEl = document.getElementById('rightButton');
  const wrongButtonEl = document.getElementById('wrongButton');
  const progressTextEl = document.getElementById('progressText');
  const reviewButtonEl = document.getElementById('reviewButton');

  const pauseOverlayEl = document.getElementById('pauseOverlay');
  const pauseProgressLabelEl = document.getElementById('pauseProgressLabel');
  const pauseScoreLabelEl = document.getElementById('pauseScoreLabel');
  const pauseTimeLabelEl = document.getElementById('pauseTimeLabel');
  const resumeButtonEl = document.getElementById('resumeButton');
  const pauseToReviewButtonEl = document.getElementById('pauseToReviewButton');

  const endOverlayEl = document.getElementById('endOverlay');
  const endTitleEl = document.getElementById('endTitle');
  const endSubtitleEl = document.getElementById('endSubtitle');
  const endCorrectLabelEl = document.getElementById('endCorrectLabel');
  const endAccuracyLabelEl = document.getElementById('endAccuracyLabel');
  const endHealthLabelEl = document.getElementById('endHealthLabel');
  const endScoreLabelEl = document.getElementById('endScoreLabel');
  const endTimeLabelEl = document.getElementById('endTimeLabel');
  const endReviewButtonEl = document.getElementById('endReviewButton');
  const endReplayButtonEl = document.getElementById('endReplayButton');

  const appEl = document.getElementById('app');
  const reviewScreenEl = document.getElementById('reviewScreen');
  const backToGameButtonEl = document.getElementById('backToGameButton');
  const reviewListEl = document.getElementById('reviewList');
  const reviewTitleEl = document.getElementById('reviewTitle');
  const reviewSubtitleEl = document.getElementById('reviewSubtitle');
  const filterAllEl = document.getElementById('filterAll');
  const filterWrongEl = document.getElementById('filterWrong');
  const filterSlowEl = document.getElementById('filterSlow');

  // Enemy helpers
  function createEnemy(initialY = 0) {
    const enemyEl = document.createElement('div');
    enemyEl.className = 'enemy';
    const x = 10 + Math.random() * 80;
    const y = initialY;
    const speed = 0.45 + Math.random() * 0.3;
    playfieldEl.appendChild(enemyEl);
    const enemy = { el: enemyEl, x, y, speed };
    enemies.push(enemy);
    positionEnemy(enemy);
  }

  function positionEnemy(enemy) {
    enemy.el.style.left = enemy.x + '%';
    enemy.el.style.top = enemy.y + '%';
  }

  function resetEnemy(enemy) {
    enemy.y = -5 - Math.random() * 10;
    enemy.x = 10 + Math.random() * 80;
    enemy.speed = 0.45 + Math.random() * 0.3;
    positionEnemy(enemy);
  }

  function updateEnemies() {
    if (paused || enemies.length === 0) return;
    const damagePerHit = 8;

    enemies.forEach(enemy => {
      enemy.y += enemy.speed;
      if (enemy.y >= 100) {
        resetEnemy(enemy);
        if (!baseDestroyed) {
          baseHealth = Math.max(0, baseHealth - damagePerHit);
          updateBaseHealth();
        }
      } else {
        positionEnemy(enemy);
      }
    });
  }

  function destroyClosestEnemy() {
    if (enemies.length === 0) return;
    let target = enemies[0];
    enemies.forEach(e => {
      if (e.y > target.y) target = e;
    });
    target.y -= 30;
    if (target.y < -15) target.y = -15;
    positionEnemy(target);
  }

  function speedUpEnemies(amount = 0.08) {
    enemies.forEach(e => { e.speed += amount; });
  }

  function fireLaser() {
    const laserEl = document.createElement('div');
    laserEl.className = 'laser';
    playfieldEl.appendChild(laserEl);
    setTimeout(() => {
      if (laserEl.parentNode) laserEl.parentNode.removeChild(laserEl);
    }, 380);
    destroyClosestEnemy();
  }

  function updateBaseHealth() {
    const ratio = baseHealth / 100;
    baseHealthInnerEl.style.transform = 'scaleX(' + ratio.toFixed(2) + ')';
    if (baseHealth <= 0 && !baseDestroyed) {
      baseDestroyed = true;
      flashPlayfield(false);
    }
  }

  function flashPlayfield(good) {
    playfieldEl.classList.remove('flash-good', 'flash-bad');
    void playfieldEl.offsetWidth;
    playfieldEl.classList.add(good ? 'flash-good' : 'flash-bad');
  }

  // Card & HUD helpers
  function formatTime(ms) {
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;
    return (m < 10 ? '0' + m : '' + m) + ':' + (s < 10 ? '0' + s : '' + s);
  }

  function updateHud() {
    const total = cards.length;
    const current = Math.min(currentIndex + 1, total);
    hudCardsEl.textContent = current + ' / ' + total;
    scoreValueEl.textContent = Math.round(score);
    progressTextEl.textContent = 'Card ' + current + ' / ' + total;
  }

  function updateTimer() {
    if (!sessionStart) return;
    const now = Date.now();
    const elapsedMs = now - sessionStart;
    timerValueEl.textContent = formatTime(elapsedMs);
  }

  function updateCardTimerBar() {
    const ratio = Math.max(0, Math.min(1, cardTimeRemainingMs / cardTimerTotalMs));
    cardTimerBarEl.style.transform = 'scaleX(' + ratio.toFixed(3) + ')';
    if (revealShown && !cardCompleted) {
      if (ratio > 0.66) {
        cardSpeedLabelEl.textContent = 'Speed bonus ready';
        cardSpeedLabelEl.style.color = '#22c55e';
      } else if (ratio > 0.33) {
        cardSpeedLabelEl.textContent = 'Decent timing';
        cardSpeedLabelEl.style.color = '#3fb9ff';
      } else if (ratio > 0) {
        cardSpeedLabelEl.textContent = 'Timer ticking down';
        cardSpeedLabelEl.style.color = '#fbbf24';
      } else {
        cardSpeedLabelEl.textContent = 'Time penalty';
        cardSpeedLabelEl.style.color = '#f97316';
      }
    } else {
      cardSpeedLabelEl.textContent = 'Beat the timer!';
      cardSpeedLabelEl.style.color = '#3fb9ff';
    }
  }

  function onCardTimerExpired() {
    if (cardTimerExpired) return;
    cardTimerExpired = true;
    speedUpEnemies(0.15);
    flashPlayfield(false);
  }

  function showCard(index) {
    const card = cards[index];
    currentIndex = index;
    revealShown = false;
    cardCompleted = false;
    cardTimeRemainingMs = cardTimerTotalMs;
    cardTimerExpired = false;
    currentRevealTime = null;
    cardIndexLabelEl.textContent = 'Card ' + (index + 1);
    questionTextEl.textContent = card.q;
    answerTextEl.textContent = card.a;
    answerTextEl.classList.add('hidden');
    revealRowEl.classList.remove('hidden');
    markRowEl.classList.add('hidden');
    updateCardTimerBar();
    updateHud();
  }

  function handleReveal() {
    if (revealShown || paused) return;
    revealShown = true;
    currentRevealTime = Date.now();
    answerTextEl.classList.remove('hidden');
    revealRowEl.classList.add('hidden');
    markRowEl.classList.remove('hidden');
    updateCardTimerBar();
  }

  function handleAnswer(correct) {
    if (!revealShown || cardCompleted) return;
    cardCompleted = true;

    const now = Date.now();
    const rtMs = currentRevealTime ? (now - currentRevealTime) : 0;
    const rtSeconds = rtMs / 1000;

    let speedTier;
    if (rtSeconds <= 3) speedTier = 3;
    else if (rtSeconds <= 7) speedTier = 2;
    else speedTier = 1;

    let basePoints = correct ? 100 : 0;
    let timeBonus = correct ? (speedTier * 40) : 0;
    if (cardTimerExpired) {
      timeBonus *= 0.4;
    }
    const points = basePoints + timeBonus;

    if (correct) {
      score += points;
      correctCount += 1;
      fireLaser();
      flashPlayfield(true);
    } else {
      const missDamage = 15;
      if (!baseDestroyed) {
        baseHealth = Math.max(0, baseHealth - missDamage);
        updateBaseHealth();
      }
      speedUpEnemies(0.08);
      flashPlayfield(false);
    }

    attempts.push({
      index: currentIndex + 1,
      question: cards[currentIndex].q,
      answer: cards[currentIndex].a,
      correct,
      responseTimeMs: rtMs
    });

    updateHud();

    setTimeout(() => {
      const next = currentIndex + 1;
      if (next < cards.length) {
        showCard(next);
      } else {
        endSession();
      }
    }, 250);
  }

  function endSession() {
    clearInterval(timerIntervalId);
    timerIntervalId = null;
    paused = true;

    const total = cards.length;
    const incorrectCount = total - correctCount;
    const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    const health = Math.round(baseHealth);

    endCorrectLabelEl.textContent = correctCount + ' / ' + total;
    endAccuracyLabelEl.textContent = accuracy + '%';
    endHealthLabelEl.textContent = health + '%';
    endScoreLabelEl.textContent = Math.round(score);

    if (sessionStart) {
      const elapsed = Date.now() - sessionStart;
      endTimeLabelEl.textContent = formatTime(elapsed);
    } else {
      endTimeLabelEl.textContent = '00:00';
    }

    if (health <= 0) {
      endTitleEl.textContent = 'Base overrun';
      endSubtitleEl.textContent = 'The siege got through, but the reps still count.';
    } else if (incorrectCount === 0) {
      endTitleEl.textContent = 'Perfect wave';
      endSubtitleEl.textContent = 'Clean sweep. Every card, every shot on target.';
    } else {
      endTitleEl.textContent = 'Wave cleared';
      endSubtitleEl.textContent = 'Nice run. Use review to lock in the details.';
    }

    reviewButtonEl.disabled = false;
    endOverlayEl.classList.remove('hidden');
  }

  function openReviewScreen(filter) {
    appEl.classList.add('hidden');
    reviewScreenEl.classList.remove('hidden');
    renderReview(filter || 'all');
  }

  function closeReviewScreen() {
    reviewScreenEl.classList.add('hidden');
    appEl.classList.remove('hidden');
  }

  function renderReview(filterMode) {
    let list = attempts.slice();

    if (filterMode === 'wrong') {
      list = list.filter(a => !a.correct);
      reviewTitleEl.textContent = 'Wrong cards';
      reviewSubtitleEl.textContent = list.length ? 'These are the ones that hit the base.' : 'No wrong cards this run.';
    } else if (filterMode === 'slow') {
      list.sort((a, b) => (b.responseTimeMs || 0) - (a.responseTimeMs || 0));
      reviewTitleEl.textContent = 'Slowest answers';
      reviewSubtitleEl.textContent = 'Top of the list = most time taken.';
    } else {
      reviewTitleEl.textContent = 'Run breakdown';
      reviewSubtitleEl.textContent = 'Tap a filter to focus weak spots.';
    }

    [filterAllEl, filterWrongEl, filterSlowEl].forEach(btn => btn.classList.remove('primary'));
    if (filterMode === 'wrong') filterWrongEl.classList.add('primary');
    else if (filterMode === 'slow') filterSlowEl.classList.add('primary');
    else filterAllEl.classList.add('primary');

    reviewListEl.innerHTML = '';
    if (!list.length) {
      const emptyEl = document.createElement('div');
      emptyEl.className = 'review-empty';
      emptyEl.textContent = 'Nothing to show yet.';
      reviewListEl.appendChild(emptyEl);
      return;
    }

    list.forEach(item => {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'review-item ' + (item.correct ? 'correct' : 'wrong');

      const header = document.createElement('div');
      header.className = 'review-header';

      const leftSpan = document.createElement('span');
      leftSpan.textContent = '#' + item.index + (item.correct ? ' · Correct' : ' · Wrong');

      const rightSpan = document.createElement('span');
      rightSpan.className = 'side';

      const timeSec = item.responseTimeMs ? (item.responseTimeMs / 1000).toFixed(1) : '0.0';
      const timeBadge = document.createElement('span');
      timeBadge.className = 'badge ' + (item.responseTimeMs >= cardTimerTotalMs ? 'slow' : (item.correct ? 'good' : 'bad'));
      timeBadge.textContent = timeSec + 's';

      rightSpan.appendChild(timeBadge);
      header.appendChild(leftSpan);
      header.appendChild(rightSpan);

      const qDiv = document.createElement('div');
      qDiv.className = 'review-q';
      const qShort = item.question.length > 160 ? item.question.slice(0, 157) + '…' : item.question;
      qDiv.textContent = qShort;

      const aDiv = document.createElement('div');
      aDiv.className = 'review-a';
      aDiv.textContent = item.answer;

      cardDiv.appendChild(header);
      cardDiv.appendChild(qDiv);
      cardDiv.appendChild(aDiv);
      reviewListEl.appendChild(cardDiv);
    });
  }

  function setPaused(nextPaused) {
    if (paused === nextPaused) return;
    paused = nextPaused;

    if (paused) {
      pauseIconEl.textContent = '▶';
      pauseLabelEl.textContent = 'Resume';
      updateTimer();
      pauseProgressLabelEl.textContent = (currentIndex + 1) + ' / ' + cards.length;
      pauseScoreLabelEl.textContent = Math.round(score);
      if (sessionStart) {
        const elapsed = Date.now() - sessionStart;
        pauseTimeLabelEl.textContent = formatTime(elapsed);
      } else {
        pauseTimeLabelEl.textContent = '00:00';
      }
      pauseOverlayEl.classList.remove('hidden');
    } else {
      pauseIconEl.textContent = '⏸';
      pauseLabelEl.textContent = 'Pause';
      pauseOverlayEl.classList.add('hidden');
      if (!timerIntervalId) {
        timerIntervalId = setInterval(tick, 100);
      }
    }
  }

  function tick() {
    if (paused) return;
    updateTimer();

    if (revealShown && !cardCompleted) {
      cardTimeRemainingMs -= 100;
      if (cardTimeRemainingMs <= 0) {
        cardTimeRemainingMs = 0;
        if (!cardTimerExpired) {
          onCardTimerExpired();
        }
      }
      updateCardTimerBar();
    }

    updateEnemies();
  }

  function init() {
    sessionStart = Date.now();
    for (let i = 0; i < 4; i++) {
      createEnemy(-10 - i * 10);
    }
    updateBaseHealth();
    showCard(0);
    reviewButtonEl.disabled = true;
    timerIntervalId = setInterval(tick, 100);
  }

  // Event listeners
  revealButtonEl.addEventListener('click', handleReveal);
  rightButtonEl.addEventListener('click', () => handleAnswer(true));
  wrongButtonEl.addEventListener('click', () => handleAnswer(false));

  pauseButtonEl.addEventListener('click', () => {
    setPaused(!paused);
  });

  resumeButtonEl.addEventListener('click', () => {
    setPaused(false);
  });

  pauseToReviewButtonEl.addEventListener('click', () => {
    pauseOverlayEl.classList.add('hidden');
    openReviewScreen('all');
  });

  reviewButtonEl.addEventListener('click', () => {
    setPaused(true);
    openReviewScreen('all');
  });

  endReviewButtonEl.addEventListener('click', () => {
    endOverlayEl.classList.add('hidden');
    openReviewScreen('wrong');
  });

  endReplayButtonEl.addEventListener('click', () => {
    window.location.reload();
  });

  backToGameButtonEl.addEventListener('click', () => {
    closeReviewScreen();
    endOverlayEl.classList.add('hidden');
    if (!timerIntervalId) {
      timerIntervalId = setInterval(tick, 100);
    }
    paused = false;
    pauseIconEl.textContent = '⏸';
    pauseLabelEl.textContent = 'Pause';
  });

  filterAllEl.addEventListener('click', () => renderReview('all'));
  filterWrongEl.addEventListener('click', () => renderReview('wrong'));
  filterSlowEl.addEventListener('click', () => renderReview('slow'));

  document.addEventListener('visibilitychange', () => {
    if (document.hidden && !paused && !endOverlayEl.classList.contains('hidden')) {
      // session finished; no need to auto-pause
      return;
    }
    if (document.hidden && !paused) {
      setPaused(true);
    }
  });

  init();
</script>


</body>
</html>
