<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Cloze Cards Reviewer ‚Äî JSON ‚Üí Visual ‚Üí Save/Discard</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --surface:#1e222b; --muted:#96a0af; --text:#e7eaf0;
    --accent:#9b87fd; --accent-weak:#b6a9ff; --good:#2ecc71; --bad:#e74c3c; --warn:#f39c12;
    --ring:0 0 0 2px rgba(155,135,253,.35);
    --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
    --code:#0b0d12;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial}
  body.modalOpen{overflow:hidden}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  /* Prevent double-tap zoom on interactive controls */
  html, body { touch-action: manipulation; }
  button, .btn, .segbtn, a, [role="button"] {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .wrap{max-width:880px;margin:0 auto;padding:16px}
  header{
    position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.8));
    backdrop-filter: blur(8px); border-bottom:1px solid #262b35;
  }
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px}
  .toolbar .title{font-weight:700;font-size:18px;margin-right:auto}
  .btn{
    border:1px solid #2a3140;background:var(--surface);color:var(--text);
    padding:9px 12px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);
  }
  .btn:focus{outline:none;box-shadow:var(--ring)}
  .btn.primary{background:var(--accent);border-color:transparent;color:#0b0d12}
  .btn.good{background:var(--good);border-color:transparent;color:#0b0d12}
  .btn.bad{background:#ff6b6b;border-color:transparent;color:#0b0d12}
  .btn.warn{background:var(--warn);border-color:transparent;color:#0b0d12}
  .btn.blue { background:#4a90e2; border-color:transparent; color:#0b0d12 }
  .btn.red { background:#e74c3c; border-color:transparent; color:#0b0d12 }
  .btn.green { background:#2ecc71; border-color:transparent; color:#0b0d12 }

  .seg{display:flex;gap:6px;background:var(--panel);padding:6px;border-radius:10px;border:1px solid #293042}
  .seg .segbtn{
    background:transparent;border:0;color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer
  }
  .seg .segbtn.active{background:var(--surface);color:var(--text);box-shadow:var(--ring)}
  .searchRow{display:flex;gap:10px;flex-wrap:wrap;width:100%}
  .input, textarea{
    background:#141821;border:1px solid #2b3243;color:var(--text);
    padding:10px 12px;border-radius:10px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.2)
  }
  .input:focus, textarea:focus{outline:none;box-shadow:var(--ring)}
  textarea{width:100%;min-height:160px;resize:vertical}

  .cardlist{display:flex;flex-direction:column;gap:14px;margin-top:14px}
  .card{
    position:relative;
    background:var(--surface);border:1px solid #2b3243;border-radius:var(--radius);padding:12px;
    box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px
  }
  .statusBar{
    margin:-12px -12px 8px -12px;
    padding:4px 10px;
    border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);
    display:flex;align-items:center;
  }
  .statusTitle{
    flex:1;text-align:center;font-weight:700;letter-spacing:.03em;font-size:13px;color:#0b0d12;
  }
  .status-new{background:linear-gradient(180deg,#f7c948,#996c00)}
  .status-saved{background:linear-gradient(180deg,#2ecc71,#0e8f49)}
  .status-discarded{background:linear-gradient(180deg,#ff6b6b,#b02a2a)}
  .clozeTop{
    margin-left:auto;display:flex;align-items:center;gap:6px;
    background:#00000022;border:1px solid #00000033;border-radius:999px;padding:2px 6px;
  }
  .clozeTop .miniBtn{
    border:1px solid #00000055;background:#00000033;color:#ffffff;border-radius:8px;
    padding:2px 6px;cursor:pointer;font-size:12px;line-height:1
  }
  .clozeTop .indicator{font:12px/1.2 ui-monospace,SFMono,Menlo,Consolas;color:#ffffffcc}
  .meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px}
  .tags{display:flex;flex-wrap:wrap;gap:6px}
  .notehtml{line-height:1.55;font-size:16px}
  .notehtml .cloze, .notehtml .cloze b, .notehtml .cloze i, .notehtml .cloze u{
    color:#0b0d12;background:var(--accent);padding:1px 5px;border-radius:6px;font-weight:700
  }
  .notehtml .ghost{
    color:var(--accent-weak);border:1px dashed #3c3f55;padding:1px 5px;border-radius:6px;opacity:.9
  }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row .btn.small{padding:6px 9px;border-radius:8px;font-size:13px}
  .row.right{margin-left:auto}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#151925;border:1px solid #2b3243;color:#cbd3df;font-size:13px}
  .hidden{display:none !important}
  .gridFooter{display:flex;justify-content:space-between;align-items:center;margin-top:14px;color:var(--muted)}

  .modalBackdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;z-index:20;
    backdrop-filter: blur(6px);
  }
  .modal{width:min(760px,94vw);max-height:90vh;overflow:auto;background:var(--panel);border:1px solid #2b3243;border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .modal header{border:0;background:transparent;position:sticky;top:0;padding-bottom:8px}
  .f1{flex:1}
  .hr{height:1px;background:#2b3243;margin:10px 0;border-radius:1px}
</style>
</head>
<body>
<header>
  <div class="toolbar wrap">
    <div class="title">Cloze Cards Reviewer</div>
    <div class="seg" role="tablist" aria-label="Views">
      <!-- Moved ALL to the far left and made it active by default -->
      <button class="segbtn active" data-view="all">All</button>
      <button class="segbtn" data-view="new">New</button>
      <button class="segbtn" data-view="saved">Saved</button>
      <button class="segbtn" data-view="discarded">Discarded</button>
    </div>
    <button class="btn" id="soloBtn" title="One-at-a-time viewer (optional)">Solo View</button>
    <div class="searchRow">
      <input class="input" id="search" placeholder="Search">
    </div>
    <div class="row">
      <button class="btn" id="copyAllBtn" title="Copy all visible" style="display:none;">Copy Visible</button>
      <button class="btn" id="apkgBtn" title="Download .apkg" style="display:none;">Download APKG</button>
      <button class="btn" id="toggleTagsBtn" title="Show/Hide tags">Show Tags</button>
      <button class="btn warn" id="nukeBtn" title="Clear local data">Reset</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="ingest">
    <p class="muted mini">Paste JSON produced by your chatbot and click <b>Load JSON</b>. Accepted shapes:
      <code class="pill">["..."]</code>,
      <code class="pill">[{ "content": "..." }]</code>,
      <code class="pill">[{ "html": "...", "tags": ["‚Ä¶"], "id": "‚Ä¶" }]</code>.
      Each string/object must contain <b>cloze HTML</b> like <code>{{c1::answer}}</code>.
    </p>
    <textarea id="jsonInput" placeholder='[
  "What is the capital of Australia?<br><br>{{c1::Canberra}}",
  {"content": "The three branches are {{c1::executive}}, {{c1::legislative}}, and {{c1::judicial}}.", "tags":["civics"]},
  {"html":"{{c1::Jupiter}} is the largest planet.", "id":"note-42", "tags":["astro","giants"]}
]'></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="loadBtn">Load JSON</button>
    </div>
  </section>

  <section id="listArea" class="hidden">
    <div class="gridFooter">
      <div><span id="countLabel">0</span> cards</div>
      <div></div>
    </div>
    <div id="cards" class="cardlist" aria-live="polite"></div>
  </section>

  <section id="appendArea" class="hidden" style="margin-top:28px;">
    <div class="hr"></div>
    <h3 style="margin:0 0 8px 0;">Add More Cards</h3>
    <textarea id="appendInput" placeholder='["Another {{c1::card}}", {"content":"More {{c1::items}}"}]'></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="appendBtn">Append JSON</button>
    </div>
  </section>
</main>

<!-- Solo modal -->
<div class="modalBackdrop" id="soloBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="soloTitle">
    <header class="row" style="gap:10px;">
      <div id="soloTitle" class="f1">Solo View</div>
      <button class="btn" id="soloPrev"><span>‚Üê</span> Prev</button>
      <button class="btn" id="soloNext">Next <span>‚Üí</span></button>
      <button class="btn bad" id="soloClose">Close</button>
    </header>
    <div class="hr"></div>
    <div id="soloCard" class="card"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn good small" id="soloSave">‚≠ê Save</button>
      <button class="btn small" id="soloCopy">üìã Copy</button>
      <button class="btn small" id="soloEdit">‚úèÔ∏è Edit</button>
      <button class="btn bad small" id="soloDiscard">üóëÔ∏è Discard</button>
    </div>
  </div>
</div>

<script>
(() => {
  const el = sel => document.querySelector(sel);
  const els = sel => Array.from(document.querySelectorAll(sel));
  const storeKey = "cloze-reviewer-v1";
  const tagsKey = "cloze-reviewer-tags-visible";
  let notes = [];
  // Default view changed to "all"
  let view = "all";
  let searchTerm = "";
  let lastRendered = [];
  let soloIndex = 0;
  const uiState = {};
  let tagsVisible = (() => {
    try { const v = localStorage.getItem(tagsKey); return v === null ? false : v === "1"; }
    catch { return false; }
  })();

  // ---- Kill double-tap zoom (iOS Safari & friends) but keep rapid taps working
  (function preventDoubleTapZoom(){
    const isEditable = el =>
      !!(el && el.closest('input, textarea, [contenteditable="true"]'));
    document.addEventListener('dblclick', (e) => {
      if (isEditable(e.target)) return;
      e.preventDefault();
    }, { passive: false, capture: true });
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
      if (e.touches && e.touches.length) return;
      if (isEditable(e.target)) return;
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
        const target = e.target.closest('button, .btn, .segbtn, a, [role="button"]');
        if (target) target.click();
      }
      lastTouchEnd = now;
    }, { passive: false, capture: true });
  })();

  // Scroll lock helpers
  let wheelPreventHandler = null, touchPreventHandler = null;
  function openModalBackdrop(div){
    document.body.classList.add("modalOpen");
    wheelPreventHandler = (e)=>{ if (!div.contains(e.target)) e.preventDefault(); };
    touchPreventHandler = (e)=>{ if (!div.contains(e.target)) e.preventDefault(); };
    document.addEventListener("wheel", wheelPreventHandler, {passive:false, capture:true});
    document.addEventListener("touchmove", touchPreventHandler, {passive:false, capture:true});
    div.style.display = "flex"; div.setAttribute("aria-hidden","false");
  }
  function closeModalBackdrop(div){
    div.style.display = "none"; div.setAttribute("aria-hidden","true");
    if (wheelPreventHandler) document.removeEventListener("wheel", wheelPreventHandler, {capture:true});
    if (touchPreventHandler) document.removeEventListener("touchmove", touchPreventHandler, {capture:true});
    wheelPreventHandler = touchPreventHandler = null;
    document.body.classList.remove("modalOpen");
  }

  try {
    const raw = localStorage.getItem(storeKey);
    if (raw) { const parsed = JSON.parse(raw); if (Array.isArray(parsed)) notes = parsed; }
  } catch {}

  function uid(){ return "n_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
  function save(){ localStorage.setItem(storeKey, JSON.stringify(notes)); }
  function trimHtml(s){ return (s||"").toString().trim(); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function getClozeNumbers(html){ const set=new Set(); const re=/{{c(\d+)::/g; let m; while((m=re.exec(html))){ set.add(parseInt(m[1],10)); } return Array.from(set).sort((a,b)=>a-b); }
  function renderClozeTarget(html, targetNum, hideTarget){
    if (!targetNum) return trimHtml(html);
    const re = /{{c(\d+)::(.*?)(?:::([^}]+))?}}/g;
    return trimHtml(html).replace(re, (_, num, ans, hint) => {
      const n = parseInt(num,10);
      const hintText = hint ? escapeHtml(hint) : "‚Ä¶";
      const ansEsc = escapeHtml(ans);
      if (n === targetNum){
        return hideTarget ? `<span class="ghost" data-c="${n}">[${hintText}]</span>` : `<span class="cloze" data-c="${n}">${ansEsc}</span>`;
      } else {
        return `<span class="cloze" data-c="${n}">${ansEsc}</span>`;
      }
    });
  }
  function normalizeInput(input){
    const out = [];
    const tryStr = v => typeof v === "string" ? v : (v && typeof v.content === "string" ? v.content : (v && typeof v.html === "string" ? v.html : null));
    const tryTags = v => Array.isArray(v?.tags) ? v.tags.map(t=>String(t)) : [];
    (input||[]).forEach((v,i)=>{
      const html = tryStr(v); if (!html) return;
      out.push({ id:(v&&v.id)?String(v.id):uid(), html:String(html), tags:tryTags(v), status:"new", fav:false, createdAt:Date.now()+i });
    });
    return out;
  }
  function filtered(){
    let arr = notes;
    if (view === "new") arr = arr.filter(n => n.status === "new");
    else if (view === "saved") arr = arr.filter(n => n.status === "saved");
    else if (view === "discarded") arr = arr.filter(n => n.status === "discarded");
    if (searchTerm) {
      const q = searchTerm.toLowerCase();
      arr = arr.filter(n => n.html.toLowerCase().includes(q) || n.tags.some(t=>t.toLowerCase().includes(q)));
    }
    return arr;
  }
  function statusClass(s){ if (s==="saved") return "status-saved"; if (s==="discarded") return "status-discarded"; return "status-new"; }
  function statusLabel(s){ return (s||"new").toUpperCase(); }
  const viewLabel = v => ({all:"All", new:"New", saved:"Saved", discarded:"Discarded"})[v] || v;

  const cardsEl = el("#cards");
  function noteToCardHtml(n){
    const nums = getClozeNumbers(n.html);
    if (!uiState[n.id]) uiState[n.id] = { nums, idx:0, hidden:true };
    else uiState[n.id].nums = nums;
    return `
      <article class="card" id="card-${n.id}" data-id="${n.id}">
        <div class="statusBar ${statusClass(n.status)}">
          <div class="statusTitle">${statusLabel(n.status)}</div>
          <div class="clozeTop ${nums.length? "" : "hidden"}">
            <button class="miniBtn" data-action="clozePrev">‚óÄ</button>
            <span class="indicator" data-role="clozeIndicator">${nums.length? ("1/"+nums.length) : ""}</span>
            <button class="miniBtn" data-action="clozeNext">‚ñ∂</button>
          </div>
        </div>
        ${tagsVisible && n.tags.length ? `<div class="meta"><div class="tags">${n.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join("")}</div></div>` : ""}
        <div class="notehtml"></div>
        <div class="row">
          <button class="btn small" data-action="copy">üìã Copy</button>
          <button class="btn small" data-action="edit">‚úèÔ∏è Edit</button>
          <button class="btn small good" data-action="save">‚≠ê Save</button>
          <button class="btn small bad" data-action="discard">üóëÔ∏è</button>
        </div>
      </article>
    `;
  }
  function renderList(){
    const cur = filtered();
    lastRendered = cur.map(n=>n.id);
    el("#countLabel").textContent = String(cur.length);
    el("#listArea").classList.toggle("hidden", cur.length === 0);
    el("#copyAllBtn").style.display = notes.length ? "" : "none";
    el("#apkgBtn").style.display = notes.length ? "" : "none";
    el("#appendArea").classList.toggle("hidden", notes.length === 0);
    cardsEl.innerHTML = cur.map(noteToCardHtml).join("");
    cur.forEach(n => wireCard(n.id));
    updateToggleTagsBtn();
  }
  function wireCard(id){
    const root = el(`#card-${CSS.escape(id)}`);
    const get = a => root.querySelector(`[data-action="${a}"]`);
    const note = notes.find(x=>x.id===id);
    const htmlBox = root.querySelector(".notehtml");
    const indicator = root.querySelector('[data-role="clozeIndicator"]');
    const nav = root.querySelector('.clozeTop');

    function update(){
      const st = uiState[id];
      const nums = st.nums; const has = nums.length>0;
      if (!has){ htmlBox.innerHTML = trimHtml(note.html); nav.classList.add('hidden'); }
      else {
        const targetNum = nums[st.idx] ?? nums[0];
        htmlBox.innerHTML = renderClozeTarget(note.html, targetNum, st.hidden);
        indicator.textContent = `${(st.idx+1)}/${nums.length}`;
        nav.classList.remove('hidden');
      }
    }
    if (!uiState[id]) uiState[id] = { nums:getClozeNumbers(note.html), idx:0, hidden:true };
    update();

    // click anywhere on the card body to reveal/hide
    root.addEventListener("click", e=>{
      if (e.target.closest(".row") || e.target.closest(".btn") || e.target.closest(".clozeTop")) return;
      uiState[id].hidden = !uiState[id].hidden; update();
    });
    const prevBtn = root.querySelector('[data-action="clozePrev"]');
    const nextBtn = root.querySelector('[data-action="clozeNext"]');
    if (prevBtn) prevBtn.addEventListener("click", (e)=>{ e.stopPropagation(); const st=uiState[id], n=st.nums.length; if(!n)return; st.idx=(st.idx-1+n)%n; st.hidden=true; update(); });
    if (nextBtn) nextBtn.addEventListener("click", (e)=>{ e.stopPropagation(); const st=uiState[id], n=st.nums.length; if(!n)return; st.idx=(st.idx+1)%n; st.hidden=true; update(); });

    get("copy").addEventListener("click", (e) => { e.stopPropagation(); navigator.clipboard.writeText(note.html).then(()=> toast("Copied")); });
    get("edit").addEventListener("click", (e) => { e.stopPropagation(); openEditor(note.id, update); });

    // Toggle save ‚Üî new
    get("save").addEventListener("click", (e) => {
      e.stopPropagation();
      if (note.status === "saved") { note.status = "new"; note.fav = false; }
      else { note.status = "saved"; note.fav = true; }
      save(); renderList();
    });

    // Toggle discard ‚Üî new
    get("discard").addEventListener("click", (e) => {
      e.stopPropagation();
      if (note.status === "discarded") { note.status = "new"; note.fav = false; }
      else { note.status = "discarded"; note.fav = false; }
      save(); if (view === "new") root.classList.add("hidden"); else renderList();
    });
  }

  function toast(msg){
    const b = document.createElement("div");
    b.textContent = msg;
    Object.assign(b.style,{position:"fixed",left:"50%",bottom:"24px",transform:"translateX(-50%)",background:"#111725",color:"#dbe5ff",border:"1px solid #2e3550",padding:"10px 14px",borderRadius:"999px",boxShadow:"var(--shadow)",zIndex:50});
    document.body.appendChild(b);
    setTimeout(()=>{ b.style.transition="all .35s ease"; b.style.opacity="0"; b.style.transform="translateX(-50%) translateY(10px)"; }, 900);
    setTimeout(()=> b.remove(), 1300);
  }

  // Simple in-app confirm modal
  function confirmModal(message){
    return new Promise(resolve=>{
      const wrap = document.createElement("div");
      wrap.className = "modalBackdrop";
      wrap.innerHTML = `
        <div class="modal" role="dialog" aria-modal="true" aria-label="Confirm">
          <header class="row"><div class="f1">Confirm</div></header>
          <div class="hr"></div>
          <p style="margin:8px 0 16px 0;">${escapeHtml(message)}</p>
          <div class="row">
            <button class="btn" data-cancel>Cancel</button>
            <button class="btn primary" data-ok>Continue</button>
          </div>
        </div>`;
      document.body.appendChild(wrap);
      openModalBackdrop(wrap);
      const ok = wrap.querySelector('[data-ok]');
      const cancel = wrap.querySelector('[data-cancel]');
      const done = (val)=>{ closeModalBackdrop(wrap); wrap.remove(); resolve(val); };
      ok.addEventListener('click', ()=>done(true));
      cancel.addEventListener('click', ()=>done(false));
      wrap.addEventListener('click', (e)=>{ if (e.target===wrap) done(false); }, {capture:true});
    });
  }

  // Editor (unchanged)
  function openEditor(id, onSaved){
    const note = notes.find(n=>n.id===id);
    const prev = note.html;
    const area = document.createElement("div");
    area.innerHTML = `
      <div class="modalBackdrop">
        <div class="modal" role="dialog" aria-modal="true">
          <header class="row"><div class="f1">Edit Card</div>
            <button class="btn bad" data-x>Close</button></header>
          <div class="hr"></div>
          <textarea class="input" id="editArea" style="width:100%;min-height:260px;font-size:24px;line-height:1.25">${escapeHtml(prev)}</textarea>
          <div class="row" style="margin-top:10px;flex-wrap:wrap">
            <button class="btn red" data-removeAll>Remove All Clozes</button>
            <div class="row" id="minusRow" style="gap:6px"></div>
            <div class="row" id="plusRow" style="gap:6px"></div>
            <button class="btn blue" data-save>Save</button>
            <button class="btn" data-preview>Preview</button>
          </div>
          <div class="hr"></div>
          <div id="preview" class="card"></div>
        </div>
      </div>
    `;
    document.body.appendChild(area);
    const backdrop = area.firstElementChild;
    openModalBackdrop(backdrop);

    const ta = area.querySelector("#editArea");
    const close = ()=>{ closeModalBackdrop(backdrop); area.remove(); };
    area.querySelector("[data-x]").onclick = close;

    function getNums(text){ return getClozeNumbers(text); }
    function rebuildPlusMinusButtons(){
      const nums = getNums(ta.value);
      const minusRow = area.querySelector("#minusRow");
      const plusRow = area.querySelector("#plusRow");
      minusRow.innerHTML = ""; plusRow.innerHTML = "";
      nums.forEach(k=>{
        const b = document.createElement("button");
        b.className = "btn red"; b.textContent = `-C${k}`;
        b.title = `Remove all C${k} clozes (reindex higher ones)`;
        b.onclick = ()=> removeCnum(k);
        minusRow.appendChild(b);
      });
      const m = nums.length ? Math.max(...nums) : 0;
      for(let k=1; k<=m+1; k++){
        const b = document.createElement("button");
        b.className = "btn green"; b.textContent = `+C${k}`;
        b.title = `Add selection as C${k}`;
        b.onclick = ()=> addClozeAs(k);
        plusRow.appendChild(b);
      }
    }
    function addClozeAs(k){
      const start = ta.selectionStart, end = ta.selectionEnd;
      if (start===end){ alert("Select text to cloze."); return; }
      const txt = ta.value, sel = txt.slice(start,end);
      const newCloze = `{{c${k}::${sel}}}`;
      ta.value = txt.slice(0,start) + newCloze + txt.slice(end);
      const pos = start + newCloze.length; ta.focus(); ta.setSelectionRange(pos,pos);
      rebuildPlusMinusButtons();
    }
    function removeAll(){
      ta.value = ta.value.replace(/{{c\d+::(.*?)(?:::([^}]+))?}}/g, "$1");
      rebuildPlusMinusButtons();
    }
    function removeCnum(k){
      let txt = ta.value;
      const reTarget = new RegExp(`{{c${k}::(.*?)(?:::([^}]+))?}}`,"g");
      txt = txt.replace(reTarget, "$1");
      let n = k+1;
      while (new RegExp(`{{c${n}::`).test(txt)) {
        const re = new RegExp(`{{c${n}::`,'g');
        txt = txt.replace(re, `{{c${n-1}::`);
        n++;
      }
      ta.value = txt;
      rebuildPlusMinusButtons();
    }
    area.querySelector("[data-removeAll]").onclick = removeAll;
    area.querySelector("[data-preview]").onclick = ()=>{
      const v = ta.value;
      const nums = getClozeNumbers(v);
      const first = nums[0] || null;
      area.querySelector("#preview").innerHTML = nums.length
        ? (`<div class="notehtml">${renderClozeTarget(v, first, true)}</div>
            <div class="hr"></div>
            <div class="notehtml">${renderClozeTarget(v, first, false)}</div>`)
        : (`<div class="notehtml">${trimHtml(v)}</div>`);
    };
    area.querySelector("[data-save]").onclick = ()=>{
      const v = ta.value;
      note.html = v; save();
      uiState[id] = { nums:getClozeNumbers(v), idx:0, hidden:true };
      renderList();
      if (typeof onSaved==="function") onSaved();
      close(); toast("Saved");
    };
    area.addEventListener("keydown", (e)=>{
      const key = e.key.toLowerCase();
      if ((e.ctrlKey||e.metaKey) && e.shiftKey && key==="c"){
        e.preventDefault();
        const nums = getClozeNumbers(ta.value);
        const next = nums.length ? Math.max(...nums)+1 : 1;
        const start = ta.selectionStart, end = ta.selectionEnd;
        if (start===end) return;
        const txt = ta.value, sel = txt.slice(start,end);
        const newCloze = `{{c${next}::${sel}}}`;
        ta.value = txt.slice(0,start) + newCloze + txt.slice(end);
        const pos = start + newCloze.length; ta.focus(); ta.setSelectionRange(pos,pos);
        rebuildPlusMinusButtons();
      }
    });
    rebuildPlusMinusButtons();
    backdrop.addEventListener("click",(e)=>{ if (e.target===backdrop) close(); },{capture:true});
  }

  // Solo view
  const soloBack = el("#soloBack");
  const soloCard = el("#soloCard");
  let soloState = { idx:0, hidden:true, nums:[] };
  function drawSolo(){
    const cur = filtered(); const n = cur[soloIndex];
    const nums = soloState.nums = getClozeNumbers(n.html);
    const target = nums[soloState.idx] || null;
    const body = nums.length ? renderClozeTarget(n.html, target, soloState.hidden) : trimHtml(n.html);
    soloCard.innerHTML = `
      <div class="statusBar ${statusClass(n.status)}">
        <div class="statusTitle">${statusLabel(n.status)}</div>
        <div class="clozeTop ${nums.length? "" : "hidden"}">
          <button class="miniBtn" id="soloClozePrev">‚óÄ</button>
          <span class="indicator" id="soloIndicator">${nums.length? (soloState.idx+1)+"/"+nums.length : ""}</span>
          <button class="miniBtn" id="soloClozeNext">‚ñ∂</button>
        </div>
      </div>
      ${tagsVisible && n.tags.length ? `<div class="meta"><div class="tags">${n.tags.map(t=>`<span class="pill">${t}</span>`).join("")}</div></div>` : ""}
      <div class="notehtml" id="soloHtml">${body}</div>
    `;
    soloCard.querySelector("#soloHtml").onclick = ()=>{ soloState.hidden = !soloState.hidden; drawSolo(); };
    const prevBtn = soloCard.querySelector("#soloClozePrev");
    const nextBtn = soloCard.querySelector("#soloClozeNext");
    if (prevBtn) prevBtn.onclick = ()=>{ if (!nums.length) return; soloState.idx=(soloState.idx-1+nums.length)%nums.length; soloState.hidden=true; drawSolo(); };
    if (nextBtn) nextBtn.onclick = ()=>{ if (!nums.length) return; soloState.idx=(soloState.idx+1)%nums.length; soloState.hidden=true; drawSolo(); };
  }
  function openSolo(index=0){
    const cur = filtered(); if (!cur.length) return;
    soloIndex = Math.max(0, Math.min(index, cur.length-1));
    soloState.idx = 0; soloState.hidden = true;
    drawSolo();
    openModalBackdrop(soloBack);
  }
  function closeSolo(){ closeModalBackdrop(soloBack); }

  // Export helpers
  function visibleNotes(){
    const ids = new Set(lastRendered);
    return notes.filter(n => ids.has(n.id));
  }
  function downloadBlob(filename, blob){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
  }

  // Toggle tags UI
  function updateToggleTagsBtn(){
    const b = el("#toggleTagsBtn");
    if (!b) return;
    b.textContent = tagsVisible ? "Hide Tags" : "Show Tags";
  }
  el("#toggleTagsBtn").addEventListener("click", ()=>{
    tagsVisible = !tagsVisible;
    try { localStorage.setItem(tagsKey, tagsVisible ? "1" : "0"); } catch {}
    renderList();
  });

  // Wire UI
  if (notes.length){ el("#ingest").classList.add("hidden"); el("#listArea").classList.remove("hidden"); el("#appendArea").classList.remove("hidden"); el("#copyAllBtn").style.display=""; el("#apkgBtn").style.display=""; }
  renderList();

  els(".segbtn").forEach(b=>{
    if (b.parentElement.getAttribute("aria-label")!=="Views") return;
    b.addEventListener("click", ()=>{
      els('.seg[aria-label="Views"] .segbtn').forEach(x=>x.classList.remove("active"));
      b.classList.add("active"); view = b.dataset.view; renderList();
    });
  });

  el("#search").addEventListener("input", e=>{ searchTerm = e.target.value.trim(); renderList(); });

  el("#loadBtn").addEventListener("click", ()=>{
    let parsed; try { parsed = JSON.parse(el("#jsonInput").value); } catch { alert("Invalid JSON"); return; }
    const normalized = normalizeInput(parsed);
    if (!normalized.length){ alert("No valid cards found."); return; }
    notes = normalized; save();
    el("#ingest").classList.add("hidden");
    el("#listArea").classList.remove("hidden");
    el("#appendArea").classList.remove("hidden");
    el("#copyAllBtn").style.display=""; el("#apkgBtn").style.display="";
    renderList(); toast("Loaded");
  });

  el("#appendBtn").addEventListener("click", ()=>{
    let parsed; try { parsed = JSON.parse(el("#appendInput").value); } catch { alert("Invalid JSON"); return; }
    const normalized = normalizeInput(parsed);
    if (!normalized.length){ alert("No valid cards found to append."); return; }
    const ids = new Set(notes.map(n=>n.id));
    normalized.forEach(n=>{ if (ids.has(n.id)) n.id = uid(); });
    notes = notes.concat(normalized); save();
    el("#appendInput").value = ""; renderList(); toast("Appended");
  });

  // Copy Visible with confirm modal
  el("#copyAllBtn").addEventListener("click", async ()=>{
    const arr = visibleNotes(); if (!arr.length) return alert("Nothing visible to copy.");
    const ok = await confirmModal(`You are about to copy from the "${viewLabel(view)}" view. Continue?`);
    if (!ok) return;
    navigator.clipboard.writeText(arr.map(n=>n.html).join("\n")).then(()=>toast("Copied visible"));
  });

  // APKG download via backend with confirm modal
  el("#apkgBtn").addEventListener("click", async ()=>{
    const arr = visibleNotes(); if (!arr.length) return alert("Nothing visible to export.");
    const ok = await confirmModal(`You are about to export from the "${viewLabel(view)}" view. Continue?`);
    if (!ok) return;
    try{
      const res = await fetch("/download_apkg", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ deck_name: "Saved Cards", notes: arr.map(n=>({html:n.html, tags:n.tags||[]})) })
      });
      if (!res.ok) throw new Error("Server error");
      const blob = await res.blob();
      downloadBlob("cards.apkg", blob);
    }catch(e){
      alert("APKG download failed. Is the backend running at /apkg?\n" + e.message);
    }
  });

  el("#nukeBtn").addEventListener("click", ()=>{
    if (!confirm("Clear local data and start over?")) return;
    localStorage.removeItem(storeKey);
    notes = []; renderList();
    el("#listArea").classList.add("hidden"); el("#appendArea").classList.add("hidden");
    el("#ingest").classList.remove("hidden");
    el("#copyAllBtn").style.display="none"; el("#apkgBtn").style.display="none";
  });

  // Solo controls
  el("#soloBtn").addEventListener("click", ()=> openSolo(0));
  el("#soloClose").addEventListener("click", closeSolo);
  el("#soloPrev").addEventListener("click", ()=> { if (soloIndex>0){ soloIndex--; drawSolo(); } });
  el("#soloNext").addEventListener("click", ()=> { const m=filtered().length-1; if (soloIndex<m){ soloIndex++; drawSolo(); } });
  el("#soloCopy").addEventListener("click", ()=> { const cur = filtered()[soloIndex]; navigator.clipboard.writeText(cur.html).then(()=>toast("Copied")); });

  // Solo Save/Discard toggle behavior mirrors list
  el("#soloSave").addEventListener("click", ()=>{ 
    const cur=filtered()[soloIndex]; 
    if (!cur) return;
    if (cur.status === "saved") { cur.status = "new"; cur.fav = false; }
    else { cur.status = "saved"; cur.fav = true; }
    save(); renderList(); drawSolo();
  });
  el("#soloDiscard").addEventListener("click", ()=>{
    const cur=filtered()[soloIndex]; 
    if (!cur) return;
    if (cur.status === "discarded") { cur.status = "new"; cur.fav = false; }
    else { cur.status = "discarded"; cur.fav = false; }
    save(); renderList(); drawSolo();
  });

  window.addEventListener("keydown", (e)=>{
    if (el("#soloBack").style.display==="flex"){
      if (e.key==="Escape"){ closeSolo(); }
      else if (e.key==="ArrowLeft"){ el("#soloPrev").click(); }
      else if (e.key==="ArrowRight"){ el("#soloNext").click(); }
      else if (e.key===" "){ e.preventDefault(); const body = el("#soloCard #soloHtml"); if (body) body.click(); }
      else if (e.key.toLowerCase()==="s"){ el("#soloSave").click(); }
      else if (e.key.toLowerCase()==="d"){ el("#soloDiscard").click(); }
      else if (e.key.toLowerCase()==="e"){ el("#soloEdit").click(); }
      else if (e.key.toLowerCase()==="c"){ el("#soloCopy").click(); }
    }
  });
  el("#soloBack").addEventListener("click", (e)=>{ if (e.target===el("#soloBack")) closeSolo(); });

  // üîÅ Keep-alive ping every ~10s to prevent Render free dyno sleep
  setInterval(() => { fetch("/ping").catch(()=>{}); }, 10000);

})();
</script>
</body>
</html>
